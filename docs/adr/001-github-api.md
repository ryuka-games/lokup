# ADR-001: GitHub REST API を使用する

## Status

Accepted

## Context

Lokupは GitHub リポジトリの健康診断を行うツール。以下のデータが必要:

- コミット履歴（日時、author、変更ファイル）
- PR情報（作成日→マージ日）
- ファイルの行数
- 依存パッケージのバージョン

### 調査結果

#### 料金

| 認証状態 | レート制限 | 料金 |
|----------|-----------|------|
| 認証なし | 60リクエスト/時 | 無料 |
| 認証あり（Personal Access Token） | 5,000リクエスト/時 | 無料 |
| GitHub Enterprise Cloud | 15,000リクエスト/時 | 有料プラン |

- API自体は無料（課金はGitHub Actionsの実行時間等）
- 自分のリポジトリかどうかは関係ない
- プライベートリポジトリは認証必須

#### 代替案

1. **GitHub GraphQL API**: より効率的にデータ取得可能だが、学習コストあり
2. **git clone + ローカル解析**: 完全なデータアクセス可能だが、ストレージとパフォーマンス課題

## Decision

GitHub REST API を使用する。

理由:
- MVPとして十分な機能
- 認証ありで5,000リクエスト/時は1リポジトリの診断に十分
- ドキュメントが豊富で実装しやすい

## 検証結果（2026-01-24）

`facebook/react` リポジトリで実際にAPIを叩いて検証。

### 取得可能なデータ

| 診断項目 | 必要なデータ | APIエンドポイント | 結果 |
|----------|-------------|------------------|------|
| 変更集中リスク | コミット履歴・変更ファイル | `GET /repos/:owner/:repo/commits/:sha` | ✅ |
| 巨大ファイル | ファイル行数 | `GET /repos/:owner/:repo/contents/:path` | ✅ |
| 属人化 | コントリビューター別コミット数 | `GET /repos/:owner/:repo/contributors` | ✅ |
| 依存の古さ | package.json | `GET /repos/:owner/:repo/contents/package.json` | ✅ |
| リリースまでの日数 | PR作成日→マージ日 | `GET /repos/:owner/:repo/pulls?state=closed` | ✅ |
| 深夜労働 | コミット時間帯 | コミットの `commit.author.date` | ✅ |

### レート制限の実測

- 認証なし: 60リクエスト/時
- 6エンドポイントのテストで7リクエスト消費
- 1リポジトリの診断には十分

### 検証スクリプト

`scripts/api-test.mjs` で再現可能。

## Consequences

### Positive

- 無料で利用可能
- OAuth認証でユーザーのプライベートリポジトリにもアクセス可能
- 実装がシンプル

### Negative

- レート制限があるため、大規模リポジトリや連続診断時に注意が必要
- 一部のデータ（ファイル行数等）は追加リクエストが必要

## 設計上の制約（2026-01-24 追記）

### レート制限を超えるリスクがある機能

| 機能 | リスク | 理由 |
|------|--------|------|
| 全ファイルの行数チェック | 高 | 大規模リポジトリはファイル数千〜数万 |
| 全コミット履歴の取得 | 高 | React は 18,000+ コミット |
| 全PR取得 | 中 | 数千件あるリポジトリも |
| 連続診断 | 中 | ユーザーが何度もボタン押す |

### 必須の対策

| 対策 | 説明 | 優先度 |
|------|------|--------|
| **期間制限** | 全履歴じゃなく「直近30日」「直近100コミット」に絞る | MVP必須 |
| **レート制限監視** | 残りリクエスト数を見て、近づいたら待機/警告 | MVP必須 |
| **キャッシュ** | 一度取得したデータは保存、再リクエストしない | MVP必須 |
| **サンプリング** | 全ファイルじゃなく、変更頻度高いファイルだけチェック | 推奨 |
| **バックグラウンド処理** | 一気に取らず、ゆっくり取得してユーザーに通知 | v2以降 |

### 設計原則

**「機能でレート制限を使い切る設計にしない」**

5,000リクエスト/時を前提とした機能設計は避ける。
ユーザーが複数リポジトリを診断したり、他のツールと併用することを考慮する。

## References

- [GitHub REST API Rate Limits](https://docs.github.com/en/rest/using-the-rest-api/rate-limits-for-the-rest-api)
- [GitHub REST API Documentation](https://docs.github.com/en/rest)
